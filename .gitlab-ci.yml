stages:
  - linter
  - unit test
  - restart test environment
  - reset testing database sigo
  - integrations test
  - acceptance test
  - deployment
  - triggers

variables:
  CLI_VERSION: 10.1.6
  GIT_STRATEGY: clone

.connect_gcr: &connect_gcr
  before_script:
    - echo $GCLOUD_SERVICE_KEY > ${HOME}/gcloud-service-key.json
    - gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
    - docker login -u _json_key --password-stdin https://gcr.io < ${HOME}/gcloud-service-key.json

linter:
  stage: linter
  image: trion/ng-cli-karma:${CLI_VERSION}
  script:
    - cd angular-project
    - npm ci
    - ng lint

# unit test:
#   stage: unit test
#   image: trion/ng-cli-karma:${CLI_VERSION}
#   script:
#     - cd angular-project
#     - npm ci
#     - ng test --code-coverage --progress false --watch false
#   coverage: '/^Statements\s*:\s*([^%]+)/'

update-demos-sigo1:
  stage: restart test environment
  variables:
    ORIGIN: $ORIGIN
    CI_PIPELINE_ID: $CI_PIPELINE_ID
    PRECURSOR: $CI_PROJECT_NAME
  trigger: zweicom/cl-movistar/sigo/demos-sigo

update test environment:
  stage: reset testing database sigo
  when: manual
  script:
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass -e \"drop database  IF EXISTS OTEC\""
    # - ssh zweicom@34.122.92.38 "cd databases && git pull && sudo docker run --rm -v /home/zweicom/databases/OTEC/:/flyway/sql flyway/flyway -validateMigrationNaming=\"false\" -url=jdbc:mysql://34.122.92.38:3311  -schemas=OTEC -user=root -password=pass info"
    # - ssh zweicom@34.122.92.38 "cd databases && git pull && sudo docker run --rm -v /home/zweicom/databases/OTEC/:/flyway/sql flyway/flyway -validateMigrationNaming=\"false\" -url=jdbc:mysql://34.122.92.38:3311  -schemas=OTEC -user=root -password=pass clean"
    - ssh zweicom@34.122.92.38 "cd databases && git pull && sudo docker run --rm -v /home/zweicom/databases/OTEC/:/flyway/sql flyway/flyway -validateMigrationNaming=\"false\" -url=jdbc:mysql://34.122.92.38:3311  -schemas=OTEC -user=root -password=pass migrate"
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into proveedor_has_servicio(agencia_id,servicio_id,precio,tipo_moneda_id,numero_producto,cmarco_has_proveedor_id,estado) values (25,21,15000,2,'ZWC - Inventado',1,1)\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into servicio_has_uob(actividad_id,servicio_cod,unidad_obra_cod,clave) values (6,'D010','T383','DIBUJ')\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into servicio_has_uob(actividad_id,servicio_cod,unidad_obra_cod,clave) values (6,'D010','T382','DIBUJ')\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into servicio_has_uob(actividad_id,servicio_cod,unidad_obra_cod,clave) values (6,'D010','T376','DIBUJ')\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into usuario_has_contrato(usuario_id,contrato_id) values(2,9)\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"update contrato_marco set estado=1 where nombre='BUCLE'\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into usuario_has_contrato(usuario_id,contrato_id) values(2,24)\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"update contrato_marco set tipo_contrato_id=3 where nombre='Contrato Ordinario'\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into usuario_has_contrato(usuario_id,contrato_id) values(2,2)\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into cmarco_has_proveedor select 9,24,proveedor_id,codigo_acuerdo,sociedad_cod,fecha_inicio,fecha_fin,fecha_contable from cmarco_has_proveedor where id in (7)\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into cmarco_has_proveedor select 10,24,proveedor_id,codigo_acuerdo,sociedad_cod,fecha_inicio,fecha_fin,fecha_contable from cmarco_has_proveedor where id in (8)\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into proveedor_has_servicio(agencia_id,servicio_id,precio,tipo_moneda_id,numero_producto,cmarco_has_proveedor_id,estado) values(8,2,12070,2,'ZWC - NUMERO PRODUCTO 8',9,1)\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into agencia_preciario(agencia_id,tipo_servicio_id,monto,tipo_moneda_id,fecha_inicio,fecha_fin,estado) values (8,6,123123,2,'2022-03-28 16:16:07.867369','2027-05-06 20:02:29.000000',1)\""
    - ssh zweicom@34.122.92.38 "sudo docker exec demos-sigo_mcl_otec_db_testing_1 mysql -uroot -ppass OTEC -e \"insert into agencia_preciario(agencia_id,tipo_servicio_id,monto,tipo_moneda_id,fecha_inicio,fecha_fin,estado) values (4,6,123123,2,'2022-03-28 16:16:07.867369','2027-05-06 20:02:29.000000',1)\""
  tags:
    - repo-machine

integrations test cypress:
  image: cypress/browsers:node12.14.1-chrome85-ff81
  stage: integrations test
  needs:
    - update test environment
  script:
    - cd angular-project
    - npm ci
    - npm start & ./node_modules/.bin/wait-on http://localhost:4201
    - cd ../cypress
    - npm ci
    - npx cypress run

acceptance test:
  <<: *connect_gcr
  stage: acceptance test
  needs:
    - integrations test cypress
  image: juanpabloaj/docker-compose-google-cloud-sdk:latest
  script:
    - if [ $(docker network ls |grep web-sigo_default|wc -l) == 0 ]; then  docker network create -d bridge web-sigo_default; fi
    - docker-compose -p ${CI_PIPELINE_ID} -f docker-compose.yml down -v
    - docker-compose -p ${CI_PIPELINE_ID} -f docker-compose.yml build --no-cache mcl_test_sigo_web
    - docker-compose -p ${CI_PIPELINE_ID} -f docker-compose.yml up -d --build mcl_test_sigo_web
    - docker network connect web-sigo_default mcl_test_sigo_web
    - docker run --name robot --shm-size=1gb --network="web-sigo_default" --user $(id -u):$(id -g) -e ROBOT_OPTIONS="--exclude automatizacion --variable url:http://mcl_test_sigo_web --variable ambiente:testing" -v /tmp/reports:/opt/robotframework/reports:Z -v /builds/cr4kQ2Xs/0/zweicom/cl-movistar/sigo/web-sigo/robot_e2e:/opt/robotframework/tests:Z ppodgorsek/robot-framework:3.8.0
  after_script:
    - docker-compose -p ${CI_PIPELINE_ID} -f docker-compose.yml down -v
    - docker stop robot
    - docker rm robot
  tags:
    - docker_sigo

docker:
  <<: *connect_gcr
  stage: deployment
  needs:
    - acceptance test
  image: juanpabloaj/docker-compose-google-cloud-sdk:latest
  script:
    - docker-compose -f docker-compose.yml build --no-cache deploy
    - docker-compose -f docker-compose.yml push deploy
  only:
    - tags
    - develop

update-demos-sigo:
  stage: triggers
  needs:
    - docker
  variables:
    ORIGIN: $ORIGIN
    CI_PIPELINE_ID: $CI_PIPELINE_ID
    PRECURSOR: $CI_PROJECT_NAME
    CI_COMMIT_AUTHOR: $CI_COMMIT_AUTHOR
    CI_COMMIT_MESSAGE: $CI_COMMIT_MESSAGE
    CI_COMMIT_DESCRIPTION: $CI_COMMIT_DESCRIPTION
    CI_COMMIT_TITLE: $CI_COMMIT_TITLE
    GITLAB_USER_NAME: $GITLAB_USER_NAME
  trigger: zweicom/cl-movistar/sigo/demos-sigo
  only:
    - develop
