<form class="carrito-container">
  <table>
    <thead>
      <tr>
        <th [attr.colspan]="colSpanServicios" style="background: var(--bg-th-servicios)">Servicios</th>
        <th [attr.colspan]="colSpanUOs">Unidad Obra</th>
      </tr>
      <tr>
        <!-- <th></th> -->
        <th style="background: var(--bg-th-servicios)">Cod</th>
        <th style="background: var(--bg-th-servicios)">Descripción</th>
        <th style="background: var(--bg-th-servicios)">Tipo</th>
        <th style="background: var(--bg-th-servicios)">Cantidad</th>
        <th style="background: var(--bg-th-servicios)" *ngIf="isBucle && canSeePrices">Puntos Baremos</th>
        <th style="background: var(--bg-th-servicios)" *ngIf="canSeePrices">Precio {{ isBucle ? 'Especialidad' :
          'Unitario' }}</th>
        <th style="background: var(--bg-th-servicios)" *ngIf="isBucle && canSeePrices">Total Baremos</th>
        <th style="background: var(--bg-th-servicios)" *ngIf="canSeePrices">Total Pesos</th>
        <th style="background: var(--bg-th-servicios)" *ngIf="column_acciones">
          Acciones
          <ng-container *ngIf="accion_aprobacion_servicio_adic">
            <div style="display:flex;flex-direction: column;align-items: center;color:white;"
              [ngClass]="formAprobarTodos.get('all').value?'recha-color':'aprob-color'">
              {{formAprobarTodos.get('all').value?'Rechazada':'Aprobada'}}
              <p-inputSwitch [formControl]="formAprobarTodos.get('all')">
              </p-inputSwitch>
            </div>
          </ng-container>
        </th>

        <!-- <th></th> -->
        <th>Cod</th>
        <th>Descripción</th>
        <th>Actividad</th>
        <th>Cantidad</th>
        <th *ngIf="canSeePrices">Precio Un.</th>
        <th *ngIf="canSeePrices">Total</th>
        <th *ngIf="accionesUOEnabled">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let servicio of data_carrito$|async;let i = index">
        <!-- TODOCOMENT: VER COMO MEJORAR ESTE WA PARA LA VISUALIZACIÓN RESPONSIVA DE LA TABLA CON UNA UO -->
        <tr style="height: 0.01rem;">
          <!-- <td [attr.rowspan]="+servicio.unidad_obras.length + 1">{{servicio.servicio_rowid}}</td> -->
          <td [attr.rowspan]="+servicio.unidad_obras.length + 1">
            {{ servicio.numero_producto }}
          </td>
          <td [attr.rowspan]="+servicio.unidad_obras.length + 1">
            <ng-container *ngIf="servicio.adicional!=='ORIGINAL' && servicio.adicional!==undefined">
              <p-tag *ngIf="servicio.adicional==='PENDIENTE'" styleClass="pendiente" value="Adicional"
                severity="warning">
              </p-tag>
              <p-tag *ngIf="servicio.adicional==='ACEPTADO'" styleClass="aceptado" value="Adicional aprobado"
                severity="success">
              </p-tag>
              <p-tag *ngIf="servicio.adicional==='RECHAZADO'" styleClass="rechazado" value="Adicional rechazado">
              </p-tag>
            </ng-container>

            <ng-container *ngIf="servicio.autorizado_ingenieria!==undefined">
              <p-tag *ngIf="servicio.autorizado_ingenieria==='PENDIENTE'" styleClass="pendiente" value="Adicional"
                severity="warning">
              </p-tag>
              <p-tag *ngIf="servicio.autorizado_ingenieria==='AUTORIZADO'" styleClass="aceptado"
                value="Ingeniería aprobada" severity="success">
              </p-tag>
              <p-tag *ngIf="servicio.autorizado_ingenieria==='RECHAZADO'" styleClass="rechazado"
                value="Ingeniería rechazada">
              </p-tag>
            </ng-container>
            {{ servicio.servicio_nombre }}
          </td>
          <td [attr.rowspan]="+servicio.unidad_obras.length + 1">{{ servicio.tipo_servicio_descripcion }}</td>

          <ng-container *ngIf="!servicio?.servicios_adicional_dummy">
            <td [attr.rowspan]="+servicio.unidad_obras.length + 1">
              <div class="container-cantidad">
                <ng-container *ngIf="cantidad_editable;else cantidad_no_editable">
                  <ng-container *ngIf="getControlServiceCantidad(servicio.servicio_id) as control">
                    <p-inputNumber [formControl]="control" mode="decimal" inputId="locale-german" locale="de-DE"
                      [minFractionDigits]="maxDecimals" (onInput)="cantidadChanged(control, $event)">
                    </p-inputNumber>
                  </ng-container>
                  <!-- <span style="color: red">{{ getControlServiceCantidad(servicio.servicio_id).errors | json }}</span> -->
                  <p [pTooltip]="servicio.servicio_unidad_descripcion">
                    {{servicio.servicio_unidad_cod}}
                  </p>
                  <zwc-input-alert [control]="getControlServiceCantidad(servicio.servicio_id)">
                  </zwc-input-alert>
                </ng-container>

                <ng-template #cantidad_no_editable>
                  {{servicio.servicio_cantidad| number}}
                  <p [pTooltip]="servicio.servicio_unidad_descripcion">
                    {{servicio.servicio_unidad_cod}}
                  </p>
                </ng-template>

              </div>
            </td>
            <td [attr.rowspan]="+servicio.unidad_obras.length + 1" *ngIf="isBucle && canSeePrices"
              style="text-align:right;">
              {{servicio.puntos_baremos}}
            </td>
            <td [attr.rowspan]="+servicio.unidad_obras.length + 1" *ngIf="canSeePrices">
              {{ +servicio.prov_has_serv_precio |
              currency: 'CLP':'$':'.0-2':'es-CL' }}
            </td>
            <td [attr.rowspan]="+servicio.unidad_obras.length + 1" *ngIf="isBucle && canSeePrices"
              style="text-align:right;">
              {{+servicio.puntos_baremos
              *+getControlServiceCantidad(servicio.servicio_id).value | number : '1.2-2'}}
            </td>
            <td [attr.rowspan]="+servicio.unidad_obras.length + 1" *ngIf="canSeePrices" style="text-align:right;">
              {{getTotal(+servicio.servicio_precio_final_clp*+getControlServiceCantidad(servicio.servicio_id).value)
              |
              currency : 'CLP' :
              '$':'.0-2':'es-CL'}}
            </td>
          </ng-container>

          <ng-container *ngIf="servicio?.servicios_adicional_dummy">
            <ng-container *ngIf="isBucle">
              <td [attr.rowspan]="+servicio.unidad_obras.length + 1" [attr.colspan]="canSeePrices?5:1">
                {{accion_aprobacion_servicio_adic || !column_acciones? 'Se le han agregado uos adicionales a
                este servicio
                existente en la cubicación' : 'Su cantidad se debe modificar desde el informe de avance'}}
              </td>
            </ng-container>
            <ng-container *ngIf="!isBucle">
              <td [attr.rowspan]="+servicio.unidad_obras.length + 1" [attr.colspan]="canSeePrices?3:1">
                {{accion_aprobacion_servicio_adic || !column_acciones? 'Se le han agregado uos adicionales a
                este servicio
                existente en la cubicación' : 'Su cantidad se debe modificar desde el informe de avance'}}
              </td>
            </ng-container>
          </ng-container>

          <td *ngIf="column_acciones" [attr.rowspan]="+servicio.unidad_obras.length + 1">
            <button *ngIf="accion_delete" (click)="deleteServicioFromCarrito(servicio)"
              class="ui button eliminar-button">
              <fa-icon [icon]="trashICon"></fa-icon>
            </button>

            <ng-container *ngIf="accion_aprobacion_servicio_adic">
              <div style="display:flex;flex-direction: column;align-items: center;color:white;"
                [ngClass]="getControlService(servicio.servicio_id,'validar_adicional').value?'recha-color':'aprob-color'">
                {{getControlService(servicio.servicio_id,'validar_adicional').value?'Rechazada':'Aprobada'}}
                <p-inputSwitch [formControl]="getControlService(servicio.servicio_id,'validar_adicional')">
                </p-inputSwitch>
              </div>
            </ng-container>

            <ng-container *ngIf="accion_subir_evidencias && servicio.precargado">
              <div class=" container-evidencias">
                <p *ngIf="servicio.requiere_evidencia && servicio.evidencia_id===null">Requiere evidencias*</p>
                <p *ngIf="servicio.requiere_evidencia && servicio.evidencia_id!==null">Evidencia enviada</p>

                <p *ngIf="!servicio.requiere_evidencia">No requiere evidencias</p>

                <button *ngIf="servicio.requiere_evidencia" (click)="viewshowSubirEvidencia(servicio)"
                  class="ui button generic-color">Subir evidencias</button>
              </div>
            </ng-container>
          </td>
        </tr>
        <ng-container *ngFor="let uo of servicio.unidad_obras; let iuo= index">
          <tr>
            <!-- <td>{{uo.uo_rowid}}</td> -->
            <td>{{ uo.uo_codigo }}</td>
            <td>

              <ng-container *ngIf="uo.adicional_existente_ia">
                <p-tag *ngIf="uo.adicional==='PENDIENTE'" styleClass="pendiente" value="Adicional" severity="warning">
                </p-tag>
                <p-tag *ngIf="uo.adicional==='ACEPTADO'" styleClass="aceptado" value="Adicional aprobado"
                  severity="success">
                </p-tag>
                <p-tag *ngIf="uo.adicional==='RECHAZADO'" styleClass="rechazado" value="Adicional rechazado">
                </p-tag>
              </ng-container>
              {{ uo.uo_nombre }}
            </td>
            <td>{{ uo.actividad_descripcion }}</td>
            <!-- SIN UO -->
            <ng-container *ngIf="uo.uo_codigo === '0'">
              <td [attr.colspan]="column_acciones?5:3" align="center">No Aplica</td>
            </ng-container>
            <!-- CON UO -->
            <ng-container *ngIf="uo.uo_codigo !== '0'">
              <td>
                <div class="container-cantidad">
                  <ng-container *ngIf="cantidad_editable;else cantidad_no_editable">
                    <ng-container *ngIf="getControlUOCantidad(servicio.servicio_id,uo.uo_codigo) as control">
                      <p-inputNumber [formControl]="control" mode="decimal" inputId="locale-german" locale="de-DE"
                        [minFractionDigits]="maxDecimals" (onInput)="cantidadChanged(control, $event)">
                      </p-inputNumber>
                    </ng-container>
                    <!-- <span style="color: red">{{ getControlUOCantidad(servicio.servicio_id,uo.uo_codigo).errors | json
                      }}</span> -->
                    <p [pTooltip]="uo.uob_unidad_medida_descripcion">
                      {{uo.uob_unidad_medida_cod }}
                    </p>
                    <zwc-input-alert [control]="getControlUOCantidad(servicio.servicio_id,uo.uo_codigo)">
                    </zwc-input-alert>
                  </ng-container>
                  <ng-template #cantidad_no_editable>
                    {{uo.uo_cantidad| number}}
                    <p [pTooltip]="uo.uob_unidad_medida_descripcion">
                      {{uo.uob_unidad_medida_cod }}
                    </p>
                  </ng-template>
                </div>
              </td>
              <td *ngIf="canSeePrices">
                {{ uo.uo_precio_total_clp | currency: 'CLP':'$':'.0-2':'es-CL' }}
              </td>
              <td *ngIf="canSeePrices">
                {{uo.uo_precio_total_clp*+getControlUOCantidad(servicio.servicio_id,uo.uo_codigo).value|
                currency : 'CLP' : '$':'.0-2':'es-CL'}}
              </td>
              <td *ngIf="accionesUOEnabled">
                <ng-container *ngIf="servicio.unidad_obras.length>1 && accion_delete">
                  <button (click)="deleteUOFromServicioFromCarrito(servicio, uo)" class="ui button eliminar-button">
                    <fa-icon [icon]="trashICon"></fa-icon>
                  </button>
                </ng-container>
                <ng-container
                  *ngIf="accion_detalle_uo && ((accion_detalle_uo_only_precargado && uo.precargado) || !accion_detalle_uo_only_precargado)">
                  <button (click)="viewDetallesUOFromServicioFromCarrito(servicio, uo)"
                    class="ui button generic-color">Detalles</button>
                </ng-container>
              </td>
            </ng-container>
          </tr>
        </ng-container>
      </ng-container>
    </tbody>
    <tfoot *ngIf="canSeePrices">
      <tr>
        <ng-container *ngIf="isBucle">
          <td [attr.colSpan]="column_acciones?5:4"></td>
          <td>Total Baremos:</td>
          <td style="text-align:right">
            {{this.totalBaremos| currency :
            'CLP' :
            '$':'.0-2':'es-CL'}}
          </td>
          <td [attr.colSpan]="column_acciones?5:4"></td>
        </ng-container>
        <ng-container *ngIf="!isBucle">
          <td [colSpan]="(+colSpanServicios-2) + (+colSpanUOs-2)"></td>
        </ng-container>

        <td [colSpan]="2">Total Servicios</td>
        <td [colSpan]="3" style="text-align:right" id="total-servicio-monto">
          {{totalServicios>99999999999999999999999?0:totalServicios| currency
          :
          'CLP' :
          '$':'.0-2':'es-CL'}}
        </td>
      </tr>
      <tr>
        <td [colSpan]="(+colSpanServicios-2) + (+colSpanUOs-2)"></td>
        <td [colSpan]="2">Total Unidades Obras</td>
        <td [colSpan]="2" style="text-align:right" id="total-uo-monto"> {{totalUOs>99999999999999999999999?0:totalUOs|
          currency : 'CLP' :
          '$':'.0-2':'es-CL'}}</td>
      </tr>
      <tr>
        <td [colSpan]="(+colSpanServicios-2) + (+colSpanUOs-2)"></td>
        <td [colSpan]="2">Total Final</td>
        <td [colSpan]="2" style="text-align:right" id="total-cubicacion-monto"> {{totalServicios+totalUOs|
          currency :
          'CLP' : '$':'.0-2':'es-CL'}}</td>
      </tr>
    </tfoot>
  </table>
</form>

<div class="message" id="alert-carrito-vacio"
  *ngIf="(data_carrito$|async).length === 0 && mode_source!=='agregar-adicionales-informe-avance' && !accion_aprobacion_servicio_adic">
  <p-message severity="error" text="Al menos 1 servicio debe ser ingresado" styleClass="mr-2"></p-message>
</div>