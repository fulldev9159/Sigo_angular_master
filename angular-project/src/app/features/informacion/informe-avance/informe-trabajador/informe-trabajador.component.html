<div class="row" style="padding: 15px">
  <ng-container *ngIf="detalleInformeAvance$ | async as detalle">
    <div class="col-xs-12 col-md-12">
      <app-card [classCardHeader]="'bg-info'">
        <ng-container card-header-title>Detalle informe de avance</ng-container>
        <ng-container card-body>
          <div class="table-carrito">
            <table style="width:100%">
              <thead>
                <tr>
                  <th colspan="5">Servicios</th>
                  <th colspan="6">Unidad Obra</th>
                </tr>
                <tr>
                  <th>Cod</th>
                  <th>Descripción</th>
                  <th>Cantidad</th>
                  <th>Unidad</th>
                  <th></th>

                  <th>Cód</th>
                  <th>Descripción</th>
                  <th>Cantidad</th>
                  <th>Unidad</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngIf="detalle.many_informe_has_servicio.length > 0 && form; else noData">
                  <ng-container *ngFor="let servicio of detalle.many_informe_has_servicio; let servicioIndex = index">
                    <ng-container *ngIf="servicio.adicional_aceptacion_estado==='ORIGINAL'">
                      <ng-container *ngIf="servicio.many_informe_has_uob.length === 1">
                        <tr [formArray]="form">
                          <td class="label-table">{{ servicio.model_servicio_id.codigo }}</td>
                          <td class="data-primaria">{{ servicio.model_servicio_id.descripcion }}</td>
                          <td>
                            <app-input [control]="form.at(servicioIndex).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                          </td>
                          <td>{{ servicio.model_unidad_id.codigo }}</td>
                          <td></td>
  
                          <td class="label-table">{{ servicio.many_informe_has_uob[0].unidad_obra_cod }}</td>
                          <td class="data-primaria">{{ servicio.many_informe_has_uob[0].model_unidad_obra_cod.descripcion }}</td>
                          <td class="data-secundaria">
                            <app-input [control]="form.at(servicioIndex).get('unidades_obras').at(0).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                          </td>
                          <td>{{ servicio.many_informe_has_uob[0].model_unidad_id.codigo }}</td>
                          <td></td>
                        </tr>
                      </ng-container>
  
                      <ng-container *ngIf="servicio.many_informe_has_uob.length > 1">
                        <tr [formArray]="form">
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length" class="label-table">{{ servicio.model_servicio_id.codigo }}</td>
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length" class="data-primaria">{{ servicio.model_servicio_id.descripcion }}</td>
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length">
                            <app-input [control]="form.at(servicioIndex).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                          </td>
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length">{{ servicio.model_unidad_id.codigo }}</td>
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length"></td>
  
                          <td class="label-table">{{ servicio.many_informe_has_uob[0].unidad_obra_cod }}</td>
                          <td class="data-primaria">{{ servicio.many_informe_has_uob[0].model_unidad_obra_cod.descripcion }}</td>
                          <td class="data-secundaria">
                            <app-input [control]="form.at(servicioIndex).get('unidades_obras').at(0).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                          </td>
                          <td>{{ servicio.many_informe_has_uob[0].model_unidad_id.codigo }}</td>
                          <td></td>
                        </tr>
                      </ng-container>
  
                      <ng-container *ngIf="servicio.many_informe_has_uob.length > 1">
                        <ng-container *ngFor="let uo of servicio.many_informe_has_uob | slice:1; let uoIndex = index">
                          <tr [formArray]="form">
                            <td class="label-table">{{ uo.unidad_obra_cod }}</td>
                            <td class="data-primaria">{{ uo.model_unidad_obra_cod.descripcion }}</td>
                            <!-- <td class="data-secundaria"> -- </td> -->
                            <td class="data-secundaria">
                              <!-- {{ uo.cantidad }} -->
                              <app-input [control]="form.at(servicioIndex).get('unidades_obras').at(uoIndex+1).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                            </td>
                            <td>{{ uo.model_unidad_id.codigo }}</td>
                            <td></td>
                          </tr>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                </ng-container>
                <ng-template #noData>
                  <tr colspan="11">No hay datos</tr>
                </ng-template>
              </tbody>
            </table>
          </div>
        </ng-container>
      </app-card>

      <br>

      <!-- <ng-container *ngIf="otId$ | async as otId">
        <ng-container *ngIf="id$ | async as id">
          <div style="text-align: right">
            <ng-container *ngIf="updating$ | async as updating; else noUpdating">
              <button class="btn btn-primary disabled">
                <em class="pi pi-spin pi-spinner mr-1"></em>Guardar borrador
              </button>
            </ng-container>
            <ng-template #noUpdating>
              <button class="btn btn-primary" (click)="saveBorradorInformeAvance(otId, id)" [class.disabled]="!valid">
                <em class="pi pi-save mr-1"></em>Guardar borrador
              </button>
            </ng-template>
          </div>
        </ng-container>
      </ng-container> -->
    </div>


    <div class="col-xs-12 col-md-12">
      <app-card [classCardHeader]="'bg-info'">
        <ng-container card-header-title>Detalle Servicios Adicionales</ng-container>
        <ng-container card-body>
          <div class="table-carrito">
            <table style="width:100%">
              <thead>
                <tr>
                  <th colspan="5">Servicios</th>
                  <th colspan="6">Unidad Obra</th>
                </tr>
                <tr>
                  <th>Cod</th>
                  <th>Descripción</th>
                  <th>Cantidad</th>
                  <th>Unidad</th>
                  <th></th>

                  <th>Cód</th>
                  <th>Descripción</th>
                  <th>Cantidad</th>
                  <th>Unidad</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngIf="detalle.many_informe_has_servicio.length > 0 && form; else noData">
                  <ng-container *ngFor="let servicio of detalle.many_informe_has_servicio; let servicioIndex = index">
                    <ng-container *ngIf="servicio.adicional_aceptacion_estado!=='ORIGINAL'">
                      <ng-container *ngIf="servicio.many_informe_has_uob.length === 1">
                        <tr [formArray]="form">
                          <td class="label-table">{{ servicio.model_servicio_id.codigo }}</td>
                          <td class="data-primaria">{{ servicio.model_servicio_id.descripcion }}</td>
                          <td>
                            <app-input [control]="form.at(servicioIndex).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                          </td>
                          <td>{{ servicio.model_unidad_id.codigo }}</td>
                          <td></td>
  
                          <td class="label-table">{{ servicio.many_informe_has_uob[0].unidad_obra_cod }}</td>
                          <td class="data-primaria">{{ servicio.many_informe_has_uob[0].model_unidad_obra_cod.descripcion }}</td>
                          <td class="data-secundaria">
                            <app-input [control]="form.at(servicioIndex).get('unidades_obras').at(0).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                          </td>
                          <td>{{ servicio.many_informe_has_uob[0].model_unidad_id.codigo }}</td>
                          <td></td>
                        </tr>
                      </ng-container>
  
                      <ng-container *ngIf="servicio.many_informe_has_uob.length > 1">
                        <tr [formArray]="form">
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length" class="label-table">{{ servicio.model_servicio_id.codigo }}</td>
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length" class="data-primaria">{{ servicio.model_servicio_id.descripcion }}</td>
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length">
                            <app-input [control]="form.at(servicioIndex).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                          </td>
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length">{{ servicio.model_unidad_id.codigo }}</td>
                          <td [attr.rowspan]="+servicio.many_informe_has_uob.length"></td>
  
                          <td class="label-table">{{ servicio.many_informe_has_uob[0].unidad_obra_cod }}</td>
                          <td class="data-primaria">{{ servicio.many_informe_has_uob[0].model_unidad_obra_cod.descripcion }}</td>
                          <td class="data-secundaria">
                            <app-input [control]="form.at(servicioIndex).get('unidades_obras').at(0).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                          </td>
                          <td>{{ servicio.many_informe_has_uob[0].model_unidad_id.codigo }}</td>
                          <td></td>
                        </tr>
                      </ng-container>
  
                      <ng-container *ngIf="servicio.many_informe_has_uob.length > 1">
                        <ng-container *ngFor="let uo of servicio.many_informe_has_uob | slice:1; let uoIndex = index">
                          <tr [formArray]="form">
                            <td class="label-table">{{ uo.unidad_obra_cod }}</td>
                            <td class="data-primaria">{{ uo.model_unidad_obra_cod.descripcion }}</td>
                            <!-- <td class="data-secundaria"> -- </td> -->
                            <td class="data-secundaria">
                              <!-- {{ uo.cantidad }} -->
                              <app-input [control]="form.at(servicioIndex).get('unidades_obras').at(uoIndex+1).get('cantidad')" Type="number" [errorMessageFn]="errorMessageFn"></app-input>
                            </td>
                            <td>{{ uo.model_unidad_id.codigo }}</td>
                            <td></td>
                          </tr>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                </ng-container>
                <ng-template #noData>
                  <tr colspan="11">No hay datos</tr>
                </ng-template>
              </tbody>
            </table>
          </div>
        </ng-container>
      </app-card>

      <br>

      <ng-container *ngIf="otId$ | async as otId">
        <ng-container *ngIf="id$ | async as id">
          <div style="text-align: right">
            <ng-container *ngIf="updating$ | async as updating; else noUpdating">
              <button class="btn btn-primary disabled">
                <em class="pi pi-spin pi-spinner mr-1"></em>Guardar borrador
              </button>
            </ng-container>
            <ng-template #noUpdating>
              <button class="btn btn-primary" (click)="saveBorradorInformeAvance(otId, id)" [class.disabled]="!valid">
                <em class="pi pi-save mr-1"></em>Guardar borrador
              </button>
            </ng-template>
          </div>
        </ng-container>
      </ng-container>
    </div>
    <!--
    <pre>{{ valid }}</pre>
    <pre>{{ values | json }}</pre>
    <pre>{{ detalle | json }}</pre>
    -->
  </ng-container>
</div>

<!-- <div style="padding: 8px;">
  <span *ngIf="(detalleOt$|async).tipo_subetapa_pago.slug==='OT_ET_PAGO_VALIDACION_ACTA_GESTOR'">
    <p-message severity="info" text="El informe enviado está a la espera de que el gestor lo apruebe"></p-message>&nbsp;
  </span>

  <span *ngIf="(detalleOt$|async).tipo_subetapa_pago.slug==='OT_ET_PAGO_GENERACION_ACTA'">
    <p-message severity="info" text="El informe enviado está a la espera de que el administrador lo apruebe"></p-message>&nbsp;
  </span>
  <ng-container *ngIf="(detalleOt$|async).tipo_subetapa_pago.slug==='OT_ET_PAGO_INICIO_FLUJO'">
    <p-card>
      <ng-template pTemplate="header">
        <div style="padding: 16px;">
        </div>
      </ng-template>

      <div class="info">
        <span class="info-title">
          INFO
        </span>
        <div class="data-info">
          <div class="box box-1"></div>
          <span style="margin-left: 5px;">Cambios realizados en esta sesión</span>
        </div>
        <div class="data-info">
          <div class="box box-2"></div>
          <span style="margin-left: 5px;">Valor informado es diferente al pendiente</span>
        </div>
      </div>

      <p-tabView>
        <p-tabPanel header="LPUs">
          <form [formGroup]="form">
            <table>
              <thead>
                <tr>
                  <th colspan="13" style="background: #00507a;
                      color: white;
                      text-align: center;">Mano de obra/Lpus</th>
                </tr>
                <tr>
                  <th rowspan="2">N°</th>
                  <th rowspan="2">Cor</th>
                  <th rowspan="2">Plano</th>
                  <th rowspan="2">Direccion</th>
                  <th rowspan="2">Clave</th>
                  <th rowspan="2">Código</th>
                  <th rowspan="2">Descrición</th>
                  <th rowspan="2">U.M</th>
                  <th colspan="4" style="background: #dfdfdf;
                      text-align: center;">
                    Cantidad
                  </th>
                </tr>
                <tr>
                  <th rowspan="2">Cub.</th>
                  <th rowspan="2">
                    <span>Apr</span>
                  </th>
                  <th rowspan="2">Pend.</th>
                  <th rowspan="2">Inf.</th>
                </tr>
              </thead>
              <tbody formArrayName="table">
                <tr *ngFor="let car of dataInformeAvance$|async; let i = index" [formGroupName]="i">
                  <td>{{i+1}}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>{{car.lpu_numero_producto}}</td>
                  <td>{{car.lpu_nombre}}</td>
                  <td></td>
                  <td>{{car.cantidad_cubicada}}</td>
                  <td>{{car.cantidad_aprobada_historica}}</td>
                  <td>{{car.cantidad_pendiente}}</td>
                  <td>
                    <input appInputColor [formControl]="formCntl(i)" min="0" type="number" style="width: 37px;">
                    <div *ngIf="formCntl(i).invalid && (formCntl(i).dirty || formCntl(i).touched)">
                      <p-message severity="error" text="{{ errorMessageFn(formCntl(i).errors) }}"></p-message>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </form>
        </p-tabPanel>
        <p-tabPanel header="Unidades de Obra">
          <form>
            <table>
              <thead>
                <tr>
                  <th colspan="13" style="background: #00507a;
                            color: white;
                            text-align: center;">Unidades de obra</th>
                </tr>
                <tr>
                  <th rowspan="2">Cor</th>
                  <th rowspan="2">Plano</th>
                  <th rowspan="2">Direccion</th>
                  <th rowspan="2">Clave</th>
                  <th rowspan="2">Código</th>
                  <th rowspan="2">Descrición</th>
                  <th rowspan="2">U.M</th>
                  <th colspan="4" style="background: #dfdfdf;
                            text-align: center;">
                    Cantidad
                  </th>
                  <th colspan="2" style="background: #dfdfdf;
                  text-align: center;">
                    Costos
                  </th>
                </tr>
                <tr>
                  <th rowspan="2">Cub.</th>
                  <th rowspan="2">
                    <span>Apr</span>
                  </th>
                  <th rowspan="2">Pend.</th>
                  <th rowspan="2">Inf.</th>

                  <th>P. unidad</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody>

              </tbody>
            </table>
          </form>
        </p-tabPanel>
        <p-tabPanel header="Materiales"></p-tabPanel>
      </p-tabView>
      <ng-template pTemplate="footer">
        <div style="display: flex;
          justify-content: space-evenly;">
          <button class="btn btn-primary" (click)="saveBorradorInformeAvance()"><em class="pi pi-save mr-1" id="guardar-ot"></em>Guardar borrador</button>
          <button class="btn btn-primary" (click)="sendInformeConfirmacion()"><em class="pi pi-play mr-1" id="guardar-ot"></em>Enviar informe</button>
        </div>
      </ng-template>
    </p-card>
  </ng-container>

</div>

<app-modal [display]="DisplayConfirmacionModal" (CloseEvent)="DisplayConfirmacionModal=false">
  <ng-container modal-header-title>Confirmar envío de Informe de avances</ng-container>
  <ng-container modal-content>
    <div class="content-modal">
      ¿Está seguro que desea envíar este informe de avances?
    </div>
  </ng-container>
  <ng-container modal-footer>
    <button class="btn" (click)="DisplayConfirmacionModal=false"><em class="pi pi-times-circle mr-1" id="guardar-ot"></em>Cancelar</button>
    <button class="btn btn-primary" (click)="sendInforme()"><em class="pi pi-play mr-1" id="guardar-ot"></em>Si, Enviar informe</button>
  </ng-container>
</app-modal> -->